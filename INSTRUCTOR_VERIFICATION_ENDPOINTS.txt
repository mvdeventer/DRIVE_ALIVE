"""
Append these endpoints to backend/app/routes/verification.py
"""

# Add this import at the top
from app.services.instructor_verification_service import InstructorVerificationService
from app.models.instructor_verification import InstructorVerificationToken

# Add these endpoints at the end of the file

@router.get("/instructor")
@limiter.limit("10/minute")
async def verify_instructor(
    token: str = Query(...),
    db: Session = Depends(get_db),
    request: Request = None,
):
    """
    Verify an instructor using a verification token
    This endpoint is typically accessed by admins clicking the verification link in email/WhatsApp
    """
    if not token:
        raise HTTPException(
            status_code=400,
            detail="Verification token is required"
        )
    
    try:
        success, message = InstructorVerificationService.verify_instructor_token(
            db=db,
            token=token,
        )
        
        if success:
            return {
                "status": "success",
                "message": message,
            }
        else:
            raise HTTPException(
                status_code=400,
                detail=message
            )
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error verifying instructor: {str(e)}")
        raise HTTPException(
            status_code=500,
            detail=f"Error verifying instructor: {str(e)}"
        )


@router.post("/instructor/verify-link")
@limiter.limit("10/minute")
async def verify_instructor_from_link(
    request: Request,
    db: Session = Depends(get_db),
):
    """
    Alternative endpoint for verifying instructor from link (POST method)
    Body: {"token": "..."}
    """
    body = await request.json()
    token = body.get("token")
    
    if not token:
        raise HTTPException(
            status_code=400,
            detail="Verification token is required"
        )
    
    try:
        success, message = InstructorVerificationService.verify_instructor_token(
            db=db,
            token=token,
        )
        
        if success:
            return {
                "status": "success",
                "message": message,
            }
        else:
            raise HTTPException(
                status_code=400,
                detail=message
            )
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error verifying instructor: {str(e)}")
        raise HTTPException(
            status_code=500,
            detail=f"Error verifying instructor: {str(e)}"
        )
